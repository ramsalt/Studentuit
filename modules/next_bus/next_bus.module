<?php

/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function next_bus_block_info() {
  $blocks['next_bus'] = array(
    // info: The name of the block.
    'info' => t('Show next buses'),
    // Block caching options (per role, per user, etc.)
    'cache' => DRUPAL_NO_CACHE, // default
  );
  return $blocks;
}
/**
 * Implements hook_block_configure().
 *
 * This hook declares configuration options for blocks provided by this module.
 */
function next_bus_block_configure($delta = '') {
  // The $delta parameter tells us which block is being configured.
  // In this example, we'll allow the administrator to customize
  // the text of the 'configurable text string' block defined in this module.

  $form = array();
  if ($delta == 'next_bus') {
    // All we need to provide is the specific configuration options for our
    // block. Drupal will take care of the standard block configuration options
    // (block title, page visibility, etc.) and the save button.
    $form['url_to_fetch'] = array(
      '#type' => 'textfield',
      '#title' => t('Fetch url'),
      '#size' => 60,
      
      '#default_value' => variable_get('next_bus_url_to_fetch',  'http://www.reiskollektivt.no/tfk/tekstvisning_inlined.php?mapid=853'),
    );
  }
  return $form;
}
/**
 * Implements hook_block_save().
 *
 * This hook declares how the configured options for a block
 * provided by this module are saved.
 */
function next_bus_block_save($delta = '', $edit = array()) {
  // We need to save settings from the configuration form.
  // We need to check $delta to make sure we are saving the right block.
  if ($delta == 'next_bus') {
    // Have Drupal save the string to the database.
    variable_set('next_bus_url_to_fetch', $edit['url_to_fetch']);
  }
  return;
}
/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function next_bus_block_view($delta = '') {
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'next_bus':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Next bus departures');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = _next_buses();
      break;
  }
  return $block;
}

function _next_buses(){
  $html = '';
  $url = variable_get('next_bus_url_to_fetch',  'http://www.reiskollektivt.no/tfk/tekstvisning_inlined.php?mapid=853');
  $result = drupal_http_request($url);
  if($result->code == 200){
    $html = $result->data;
  }else{
    watchdog('next_bus', 'The feed from %site seems to be broken, due to "%error".', array('%site' => 'neste avgang', '%error' => $result->code . ' ' . $result->error), WATCHDOG_WARNING);
  }
  return $html;
}
